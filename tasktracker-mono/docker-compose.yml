version: '3.8'

services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: tasktracker_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: tasktracker
      POSTGRES_PASSWORD: tasktracker
      POSTGRES_DB: tasktracker_db
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5435:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tasktracker -d tasktracker_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - tasktracker_network

  # FastAPI Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tasktracker_app
    restart: unless-stopped
    environment:
      # Application
      APP_NAME: "TaskTracker Monolithic API"
      APP_VERSION: "1.0.0"
      DEBUG: "False"
      API_V1_PREFIX: "/api/v1"
      
      # Database
      DATABASE_URL: "postgresql://tasktracker:tasktracker@db:5432/tasktracker_db"
      
      # Security
      SECRET_KEY: "your-secret-key-change-this-in-production-use-openssl-rand-hex-32"
      ALGORITHM: "HS256"
      ACCESS_TOKEN_EXPIRE_MINUTES: "30"
      
      # CORS
      BACKEND_CORS_ORIGINS: '["http://localhost:3000","http://localhost:9000","http://localhost"]'
      
      # Database Pool
      DB_POOL_SIZE: "20"
      DB_MAX_OVERFLOW: "10"
      DB_POOL_TIMEOUT: "30"
      DB_POOL_RECYCLE: "3600"
      
      # Logging
      LOG_LEVEL: "INFO"
    ports:
      - "9000:9000"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:9000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - tasktracker_network
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        sleep 5 &&
        echo 'Running database migrations...' &&
        alembic upgrade head &&
        echo 'Starting FastAPI application...' &&
        uvicorn app.main:app --host 0.0.0.0 --port 9000
      "

# Volumes for data persistence
volumes:
  postgres_data:
    driver: local
    name: tasktracker_postgres_data

# Networks
networks:
  tasktracker_network:
    driver: bridge
    name: tasktracker_network

