services:
  # PostgreSQL Database for User Service
  user-db:
    image: postgres:15-alpine
    container_name: tasktracker_user_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: tasktracker
      POSTGRES_PASSWORD: tasktracker
      POSTGRES_DB: user_db
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - user_db_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tasktracker -d user_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - tasktracker_micro_network

  # PostgreSQL Database for Task Service
  task-db:
    image: postgres:15-alpine
    container_name: tasktracker_task_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: tasktracker
      POSTGRES_PASSWORD: tasktracker
      POSTGRES_DB: task_db
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - task_db_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tasktracker -d task_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - tasktracker_micro_network

  # User Service
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      APP_NAME: "User Service"
      APP_VERSION: "1.0.0"
      DEBUG: "False"
      DATABASE_URL: "postgresql://tasktracker:tasktracker@user-db:5432/user_db"
      SECRET_KEY: "your-secret-key-change-this-in-production-use-openssl-rand-hex-32"
      ALGORITHM: "HS256"
      ACCESS_TOKEN_EXPIRE_MINUTES: "30"
      BACKEND_CORS_ORIGINS: '["http://localhost:3000","http://localhost:8000","http://localhost"]'
      DB_POOL_SIZE: "20"
      DB_MAX_OVERFLOW: "10"
      DB_POOL_TIMEOUT: "30"
      DB_POOL_RECYCLE: "3600"
      LOG_LEVEL: "INFO"
    ports:
      - "8001:8001"
    depends_on:
      user-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8001/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - tasktracker_micro_network
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        sleep 5 &&
        echo 'Running database migrations...' &&
        alembic upgrade head &&
        echo 'Starting User Service...' &&
        uvicorn app.main:app --host 0.0.0.0 --port 8001
      "

  # Task Service
  task-service:
    build:
      context: ./task-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      APP_NAME: "Task Service"
      APP_VERSION: "1.0.0"
      DEBUG: "False"
      DATABASE_URL: "postgresql://tasktracker:tasktracker@task-db:5432/task_db"
      SECRET_KEY: "your-secret-key-change-this-in-production-use-openssl-rand-hex-32"
      ALGORITHM: "HS256"
      BACKEND_CORS_ORIGINS: '["http://localhost:3000","http://localhost:8000","http://localhost"]'
      DB_POOL_SIZE: "20"
      DB_MAX_OVERFLOW: "10"
      DB_POOL_TIMEOUT: "30"
      DB_POOL_RECYCLE: "3600"
      LOG_LEVEL: "INFO"
    ports:
      - "8002:8002"
    depends_on:
      task-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8002/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - tasktracker_micro_network
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        sleep 5 &&
        echo 'Running database migrations...' &&
        alembic upgrade head &&
        echo 'Starting Task Service...' &&
        uvicorn app.main:app --host 0.0.0.0 --port 8002
      "

  # Stats Service
  stats-service:
    build:
      context: ./stats-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      APP_NAME: "Stats Service"
      APP_VERSION: "1.0.0"
      DEBUG: "False"
      SECRET_KEY: "your-secret-key-change-this-in-production-use-openssl-rand-hex-32"
      ALGORITHM: "HS256"
      TASK_SERVICE_URL: "http://task-service:8002"
      BACKEND_CORS_ORIGINS: '["http://localhost:3000","http://localhost:8000","http://localhost"]'
      LOG_LEVEL: "INFO"
    ports:
      - "8003:8003"
    depends_on:
      task-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8003/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - tasktracker_micro_network

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: tasktracker_api_gateway
    restart: unless-stopped
    environment:
      APP_NAME: "TaskTracker API Gateway"
      APP_VERSION: "1.0.0"
      DEBUG: "False"
      USER_SERVICE_URL: "http://user-service:8001"
      TASK_SERVICE_URL: "http://task-service:8002"
      STATS_SERVICE_URL: "http://stats-service:8003"
      BACKEND_CORS_ORIGINS: '["http://localhost:3000","http://localhost:8000","http://localhost"]'
      LOG_LEVEL: "INFO"
    ports:
      - "8000:8000"
    depends_on:
      user-service:
        condition: service_healthy
      task-service:
        condition: service_healthy
      stats-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - tasktracker_micro_network

# Volumes for data persistence
volumes:
  user_db_data:
    driver: local
    name: tasktracker_micro_user_db_data
  task_db_data:
    driver: local
    name: tasktracker_micro_task_db_data

# Networks
networks:
  tasktracker_micro_network:
    driver: bridge
    name: tasktracker_micro_network

